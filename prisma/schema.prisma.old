generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  password          String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId, provider])
}

model DailySales {
  id            String      @id
  vendorStoreId String
  date          DateTime    @db.Date
  orderCount    Int
  revenue       Decimal     @db.Decimal(12, 2)
  platformFee   Decimal     @db.Decimal(12, 2)
  vendorPayout  Decimal     @db.Decimal(12, 2)
  createdAt     DateTime    @default(now())
  VendorStore   VendorStore @relation(fields: [vendorStoreId], references: [id])

  @@unique([vendorStoreId, date])
  @@index([date])
  @@index([vendorStoreId, date])
  @@index([vendorStoreId])
}

model Product {
  id                String           @id
  vendorStoreId     String
  name              String
  slug              String
  description       String
  price             Decimal          @db.Decimal(10, 2)
  compareAtPrice    Decimal?         @db.Decimal(10, 2)
  sku               String?
  quantity          Int              @default(0)
  trackInventory    Boolean          @default(true)
  lowStockThreshold Int              @default(5)
  category          ProductCategory
  subcategory       String?
  tags              String[]
  hasVariants       Boolean          @default(false)
  variantType       VariantType?
  weight            Decimal?         @db.Decimal(8, 2)
  requiresShipping  Boolean          @default(true)
  metaTitle         String?          @db.VarChar(60)
  metaDescription   String?          @db.VarChar(160)
  status            ProductStatus    @default(DRAFT)
  publishedAt       DateTime?
  viewCount         Int              @default(0)
  salesCount        Int              @default(0)
  averageRating     Decimal?         @db.Decimal(3, 2)
  reviewCount       Int              @default(0)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime
  VendorStore       VendorStore      @relation(fields: [vendorStoreId], references: [id], onDelete: Cascade)
  ProductImage      ProductImage[]
  ProductReview     ProductReview[]
  ProductVariant    ProductVariant[]
  StoreOrderItem    StoreOrderItem[]

  @@unique([vendorStoreId, slug])
  @@index([category])
  @@index([category, status])
  @@index([status])
  @@index([vendorStoreId, status])
  @@index([vendorStoreId, status, quantity])
}

model ProductImage {
  id        String   @id
  productId String
  url       String
  thumbnail String?
  medium    String?
  large     String?
  altText   String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  Product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model ProductReview {
  id                 String         @id
  productId          String
  orderItemId        String         @unique
  customerId         String?
  vendorStoreId      String
  rating             Int
  title              String?        @db.VarChar(100)
  review             String
  photoUrls          String[]
  isVerifiedPurchase Boolean        @default(true)
  customerName       String
  customerEmail      String
  vendorResponse     String?
  vendorRespondedAt  DateTime?
  status             ReviewStatus   @default(PUBLISHED)
  flaggedAt          DateTime?
  flagReason         String?
  helpfulCount       Int            @default(0)
  unhelpfulCount     Int            @default(0)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime
  User               User?          @relation(fields: [customerId], references: [id])
  StoreOrderItem     StoreOrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  Product            Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  VendorStore        VendorStore    @relation(fields: [vendorStoreId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([orderItemId])
  @@index([productId, status, createdAt])
  @@index([vendorStoreId, createdAt])
}

model ProductVariant {
  id        String   @id
  productId String
  name      String
  value     String
  price     Decimal? @db.Decimal(10, 2)
  sku       String?
  quantity  Int      @default(0)
  imageUrl  String?
  available Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime
  Product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, available])
  @@index([productId])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ShopRating {
  id             String      @id
  vendorStoreId  String      @unique
  averageRating  Decimal     @db.Decimal(3, 2)
  totalReviews   Int         @default(0)
  fiveStars      Int         @default(0)
  fourStars      Int         @default(0)
  threeStars     Int         @default(0)
  twoStars       Int         @default(0)
  oneStar        Int         @default(0)
  lastCalculated DateTime    @default(now())
  updatedAt      DateTime
  VendorStore    VendorStore @relation(fields: [vendorStoreId], references: [id], onDelete: Cascade)
}

model StoreOrder {
  id                String                   @id
  orderNumber       String                   @unique
  vendorStoreId     String
  customerId        String?
  customerEmail     String
  customerName      String
  customerPhone     String?
  shippingAddress   Json
  billingAddress    Json
  subtotal          Decimal                  @db.Decimal(10, 2)
  shippingCost      Decimal                  @db.Decimal(10, 2)
  taxAmount         Decimal                  @db.Decimal(10, 2)
  discountAmount    Decimal                  @default(0) @db.Decimal(10, 2)
  total             Decimal                  @db.Decimal(10, 2)
  platformFee       Decimal                  @db.Decimal(10, 2)
  vendorPayout      Decimal                  @db.Decimal(10, 2)
  paymentProcessor  PaymentProcessor         @default(STRIPE)
  paymentIntentId   String?                  @unique
  paymentStatus     MarketplacePaymentStatus @default(PENDING)
  paidAt            DateTime?
  fulfillmentStatus FulfillmentStatus        @default(UNFULFILLED)
  shippingMethod    String?
  trackingNumber    String?
  carrier           String?
  shippedAt         DateTime?
  deliveredAt       DateTime?
  status            MarketplaceOrderStatus   @default(PENDING)
  customerNotes     String?
  internalNotes     String?
  cancelledAt       DateTime?
  cancelReason      String?
  refundedAt        DateTime?
  refundAmount      Decimal?                 @db.Decimal(10, 2)
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime
  User              User?                    @relation(fields: [customerId], references: [id])
  VendorStore       VendorStore              @relation(fields: [vendorStoreId], references: [id])
  StoreOrderItem    StoreOrderItem[]

  @@index([createdAt])
  @@index([customerEmail])
  @@index([customerId])
  @@index([fulfillmentStatus])
  @@index([paymentStatus])
  @@index([status])
  @@index([vendorStoreId, createdAt])
  @@index([vendorStoreId])
  @@index([vendorStoreId, status, createdAt])
}

model StoreOrderItem {
  id            String         @id
  storeOrderId  String
  productId     String
  variantId     String?
  name          String
  sku           String?
  price         Decimal        @db.Decimal(10, 2)
  quantity      Int
  variantName   String?
  imageUrl      String?
  createdAt     DateTime       @default(now())
  ProductReview ProductReview?
  Product       Product        @relation(fields: [productId], references: [id])
  StoreOrder    StoreOrder     @relation(fields: [storeOrderId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([storeOrderId])
}

model User {
  id            String          @id
  name          String?
  email         String?         @unique
  emailVerified DateTime?
  image         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  Account       Account[]
  ProductReview ProductReview[]
  Session       Session[]
  StoreOrder    StoreOrder[]
  VendorStore   VendorStore[]
}

model VendorStore {
  id                     String          @id
  userId                 String
  name                   String
  slug                   String          @unique
  tagline                String?         @db.VarChar(100)
  description            String?
  logoUrl                String?
  bannerUrl              String?
  email                  String
  phone                  String?
  shipFromAddress        Json?
  shippingRates          Json?
  stripeAccountId        String?         @unique
  stripeChargesEnabled   Boolean         @default(false)
  stripeDetailsSubmitted Boolean         @default(false)
  platformFeePercent     Decimal         @default(7.0) @db.Decimal(5, 2)
  totalProducts          Int             @default(0)
  totalOrders            Int             @default(0)
  totalSales             Decimal         @default(0) @db.Decimal(12, 2)
  averageRating          Decimal?        @db.Decimal(3, 2)
  totalReviews           Int             @default(0)
  isActive               Boolean         @default(true)
  createdAt              DateTime        @default(now())
  updatedAt              DateTime
  DailySales             DailySales[]
  Product                Product[]
  ProductReview          ProductReview[]
  ShopRating             ShopRating?
  StoreOrder             StoreOrder[]
  User                   User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([isActive])
  @@index([slug])
  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum FulfillmentStatus {
  UNFULFILLED
  PARTIALLY_FULFILLED
  FULFILLED
  SHIPPED
  DELIVERED
}

enum MarketplaceOrderStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
}

enum MarketplacePaymentStatus {
  PENDING
  AUTHORIZED
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum PaymentProcessor {
  STRIPE
}

enum ProductCategory {
  ACCESSORIES
  ART_AND_COLLECTIBLES
  BAGS_AND_PURSES
  BATH_AND_BEAUTY
  BOOKS_MOVIES_AND_MUSIC
  CLOTHING
  CRAFT_SUPPLIES_AND_TOOLS
  ELECTRONICS_AND_ACCESSORIES
  HOME_AND_LIVING
  JEWELRY
  PAPER_AND_PARTY_SUPPLIES
  PET_SUPPLIES
  SHOES
  TOYS_AND_GAMES
  WEDDINGS
}

enum ProductStatus {
  DRAFT
  ACTIVE
  OUT_OF_STOCK
  ARCHIVED
}

enum ReviewStatus {
  PUBLISHED
  FLAGGED
  HIDDEN
  DELETED
}

enum VariantType {
  SIZE
  COLOR
}
