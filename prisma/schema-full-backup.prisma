// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["relationJoins"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

/// User roles in the SteppersLife ecosystem
enum UserRole {
  // Platform
  ADMIN

  // Base
  USER

  // Business Owners (self-assignable)
  STORE_OWNER
  RESTAURANT_OWNER
  EVENT_ORGANIZER
  INSTRUCTOR
  SERVICE_PROVIDER
  MAGAZINE_WRITER

  // Assigned Roles
  STORE_ADMIN
  RESTAURANT_MANAGER
  RESTAURANT_STAFF
  EVENT_STAFF
  AFFILIATE
}

/// Business types in the ecosystem
enum BusinessType {
  RESTAURANT
  EVENT
  STORE
  CLASS
  SERVICE
  MAGAZINE
}

/// Role assignment status
enum RoleAssignmentStatus {
  ACTIVE
  REVOKED
  EXPIRED
}

// ============================================================================
// USER & AUTHENTICATION (NextAuth.js)
// ============================================================================

/// NextAuth.js Account model - OAuth/email provider accounts
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

/// NextAuth.js Session model
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

/// User model for NextAuth.js authentication
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  image         String?

  // NextAuth relations
  accounts Account[]
  sessions Session[]

  // Role management
  roles            UserRole[]       @default([USER])
  roleAssignments  RoleAssignment[] @relation("RoleAssignmentTarget")
  rolesAssigned    RoleAssignment[] @relation("RoleAssignmentAssigner")
  rolesRevoked     RoleAssignment[] @relation("RoleAssignmentRevoker")

  // Business ownership tracking
  ownedRestaurants Restaurant[] @relation("RestaurantOwner")
  ownedEvents      Event[]      @relation("EventOwner")
  ownedStores      Store[]      @relation("StoreOwner")
  ownedClasses     Class[]      @relation("ClassOwner")
  ownedServices    Service[]    @relation("ServiceOwner")

  // Business staff assignments
  restaurantStaff RestaurantStaff[]
  eventStaff      EventStaff[]
  storeStaff      StoreStaff[]

  // Verification
  verificationLevel    Int     @default(0) // 0 = basic, 1 = ID verified, 2 = full verification
  createdBusinessCount Int     @default(0)
  phoneVerified        Boolean @default(false)
  photoIdVerified      Boolean @default(false)

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  lastLoginAt DateTime?

  @@index([email])
  @@map("users")
}

/// NextAuth.js verification token model
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================================
// ROLE ASSIGNMENT TRACKING
// ============================================================================

/// Tracks all role assignments and revocations for audit trail
model RoleAssignment {
  id String @id @default(cuid())

  // Target user
  targetUserId String
  targetUser   User   @relation("RoleAssignmentTarget", fields: [targetUserId], references: [id], onDelete: Cascade)

  // Role information
  role      UserRole
  status    RoleAssignmentStatus @default(ACTIVE)

  // Assignment tracking
  assignedById String?
  assignedBy   User?   @relation("RoleAssignmentAssigner", fields: [assignedById], references: [id], onDelete: SetNull)
  assignedAt   DateTime @default(now())
  assignReason String?

  // Revocation tracking
  revokedById String?
  revokedBy   User?    @relation("RoleAssignmentRevoker", fields: [revokedById], references: [id], onDelete: SetNull)
  revokedAt   DateTime?
  revokeReason String?

  // Business context (if role is business-specific)
  businessType BusinessType?
  businessId   String?

  // Expiration (for temporary roles)
  expiresAt DateTime?

  @@index([targetUserId])
  @@index([status])
  @@index([role])
  @@map("role_assignments")
}

// ============================================================================
// BUSINESS MODELS (Stubs for role management)
// ============================================================================

/// Restaurant business
model Restaurant {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique

  // Owner
  ownerId     String
  owner       User     @relation("RestaurantOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  // Staff
  staff       RestaurantStaff[]

  // Status
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([ownerId])
  @@index([slug])
  @@map("restaurants")
}

/// Restaurant staff assignments
model RestaurantStaff {
  id           String   @id @default(cuid())

  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  role         UserRole // RESTAURANT_MANAGER or RESTAURANT_STAFF

  assignedAt   DateTime @default(now())

  @@unique([restaurantId, userId])
  @@index([userId])
  @@map("restaurant_staff")
}

/// Event business
model Event {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique

  // Owner
  ownerId   String
  owner     User     @relation("EventOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  // Staff
  staff     EventStaff[]

  // Status
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
  @@index([slug])
  @@map("events")
}

/// Event staff assignments
model EventStaff {
  id         String   @id @default(cuid())

  eventId    String
  event      Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  role       UserRole // EVENT_STAFF or AFFILIATE

  assignedAt DateTime @default(now())

  @@unique([eventId, userId])
  @@index([userId])
  @@map("event_staff")
}

/// Store business (E-commerce marketplace vendor store)
model Store {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique

  // Owner
  ownerId   String
  owner     User     @relation("StoreOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  // Store details
  tagline       String?  @db.VarChar(100)
  description   String?  @db.Text

  // Branding
  logoUrl       String?
  bannerUrl     String?

  // Contact
  email         String
  phone         String?

  // Shipping info
  shipFromAddress Json?  // {street, city, state, zip}
  shippingRates   Json?  // {flat: 10.00, express: 25.00, freeOver: 100}

  // Payment (Stripe Connect)
  stripeAccountId       String?  @unique
  stripeChargesEnabled  Boolean  @default(false)
  stripeDetailsSubmitted Boolean @default(false)

  // Platform settings
  platformFeePercent Decimal @default(7.0) @db.Decimal(5, 2)

  // Staff
  staff     StoreStaff[]

  // Products & Orders
  products  Product[]
  orders    Order[]

  // Stats (cached, updated via cron)
  totalProducts Int      @default(0)
  totalOrders   Int      @default(0)
  totalSales    Decimal  @default(0) @db.Decimal(12, 2)

  // Status
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
  @@index([slug])
  @@index([isActive])
  @@map("stores")
}

/// Store staff assignments
model StoreStaff {
  id         String   @id @default(cuid())

  storeId    String
  store      Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  role       UserRole // STORE_ADMIN

  assignedAt DateTime @default(now())

  @@unique([storeId, userId])
  @@index([userId])
  @@map("store_staff")
}

/// Class business
model Class {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique

  // Owner (Instructor)
  instructorId String
  instructor   User    @relation("ClassOwner", fields: [instructorId], references: [id], onDelete: Cascade)

  // Status
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([instructorId])
  @@index([slug])
  @@map("classes")
}

/// Service business
model Service {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique

  // Owner (Service Provider)
  providerId  String
  provider    User     @relation("ServiceOwner", fields: [providerId], references: [id], onDelete: Cascade)

  // Status
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([providerId])
  @@index([slug])
  @@map("services")
}

// ============================================================================
// E-COMMERCE MODELS (SteppersLife Stores Marketplace)
// ============================================================================

/// Product categories
enum ProductCategory {
  CLOTHING
  SHOES
  ACCESSORIES
}

/// Product status
enum ProductStatus {
  DRAFT        // Not visible to customers
  ACTIVE       // Visible and purchasable
  OUT_OF_STOCK // Visible but not purchasable
  ARCHIVED     // Hidden from catalog
}

/// Variant type (simple: size OR color, not both in Phase 1)
enum VariantType {
  SIZE
  COLOR
}

/// Product model
model Product {
  id            String   @id @default(cuid())

  storeId       String
  store         Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  // Basic info
  name          String
  slug          String
  description   String   @db.Text

  // Pricing
  price         Decimal  @db.Decimal(10, 2)
  compareAtPrice Decimal? @db.Decimal(10, 2)

  // Inventory
  sku           String?
  quantity      Int      @default(0)
  trackInventory Boolean @default(true)
  lowStockThreshold Int  @default(5)

  // Categorization
  category      ProductCategory
  tags          String[]

  // Variants
  hasVariants   Boolean  @default(false)
  variantType   VariantType?
  variants      ProductVariant[]

  // Images
  images        ProductImage[]

  // Shipping
  weight        Decimal? @db.Decimal(8, 2)
  requiresShipping Boolean @default(true)

  // SEO
  metaTitle     String?  @db.VarChar(60)
  metaDescription String? @db.VarChar(160)

  // Status
  status        ProductStatus @default(DRAFT)
  publishedAt   DateTime?

  // Relations
  orderItems    OrderItem[]

  // Stats
  viewCount     Int      @default(0)
  salesCount    Int      @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([storeId, slug])
  @@index([storeId, status])
  @@index([category])
  @@index([status])
  @@map("products")
}

/// Product variant
model ProductVariant {
  id          String   @id @default(cuid())

  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  name        String
  value       String

  price       Decimal? @db.Decimal(10, 2)

  sku         String?
  quantity    Int      @default(0)

  imageUrl    String?

  available   Boolean  @default(true)
  sortOrder   Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([productId])
  @@index([productId, available])
  @@map("product_variants")
}

/// Product image
model ProductImage {
  id          String   @id @default(cuid())

  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  url         String
  thumbnail   String?
  medium      String?
  large       String?

  altText     String?
  sortOrder   Int      @default(0)

  createdAt   DateTime @default(now())

  @@index([productId])
  @@map("product_images")
}

/// Order status
enum OrderStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
}

/// Payment status
enum PaymentStatus {
  PENDING
  AUTHORIZED
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

/// Fulfillment status
enum FulfillmentStatus {
  UNFULFILLED
  PARTIALLY_FULFILLED
  FULFILLED
  SHIPPED
  DELIVERED
}

/// Payment processor
enum PaymentProcessor {
  STRIPE
  SQUARE
  PAYPAL
}

/// Order model
model Order {
  id            String   @id @default(cuid())
  orderNumber   String   @unique

  storeId       String
  store         Store    @relation(fields: [storeId], references: [id])

  customerId    String?
  customerEmail String
  customerName  String
  customerPhone String?

  shippingAddress Json
  billingAddress  Json

  items         OrderItem[]

  subtotal      Decimal  @db.Decimal(10, 2)
  shippingCost  Decimal  @db.Decimal(10, 2)
  taxAmount     Decimal  @db.Decimal(10, 2)
  discountAmount Decimal @db.Decimal(10, 2) @default(0)
  total         Decimal  @db.Decimal(10, 2)

  platformFee   Decimal  @db.Decimal(10, 2)
  vendorPayout  Decimal  @db.Decimal(10, 2)

  paymentProcessor PaymentProcessor @default(STRIPE)
  paymentIntentId  String? @unique
  paymentStatus    PaymentStatus @default(PENDING)
  paidAt           DateTime?

  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED)
  shippingMethod    String?
  trackingNumber    String?
  carrier           String?
  shippedAt         DateTime?
  deliveredAt       DateTime?

  status        OrderStatus @default(PENDING)

  customerNotes String?  @db.Text
  internalNotes String?  @db.Text

  cancelledAt   DateTime?
  cancelReason  String?
  refundedAt    DateTime?
  refundAmount  Decimal? @db.Decimal(10, 2)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([storeId])
  @@index([customerId])
  @@index([customerEmail])
  @@index([status])
  @@index([paymentStatus])
  @@index([fulfillmentStatus])
  @@index([createdAt])
  @@map("orders")
}

/// Order item
model OrderItem {
  id          String   @id @default(cuid())

  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId   String
  product     Product  @relation(fields: [productId], references: [id])

  variantId   String?

  name        String
  sku         String?
  price       Decimal  @db.Decimal(10, 2)
  quantity    Int

  variantName String?
  imageUrl    String?

  createdAt   DateTime @default(now())

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

/// Platform category (managed by admin)
model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?  @db.Text
  imageUrl    String?

  parentId    String?
  parent      Category? @relation("SubCategories", fields: [parentId], references: [id])
  children    Category[] @relation("SubCategories")

  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())

  @@map("categories")
}

/// Platform settings
model PlatformSettings {
  id          String   @id @default(cuid())

  defaultPlatformFeePercent Decimal @default(7.0) @db.Decimal(5, 2)

  payoutSchedule String  @default("weekly")
  minPayoutAmount Decimal @default(10.00) @db.Decimal(10, 2)

  termsOfService  String? @db.Text
  privacyPolicy   String? @db.Text
  returnPolicy    String? @db.Text

  supportEmail    String  @default("support@stepperslife.com")
  supportPhone    String?

  allowNewVendorSignups Boolean @default(true)
  maintenanceMode       Boolean @default(false)

  updatedAt   DateTime @updatedAt

  @@map("platform_settings")
}

/// Audit log
model AuditLog {
  id          String   @id @default(cuid())

  userId      String
  userEmail   String

  action      String
  entityType  String
  entityId    String

  oldValue    Json?
  newValue    Json?
  reason      String?  @db.Text

  ipAddress   String?
  userAgent   String?

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

/// Daily sales summary
model DailySales {
  id          String   @id @default(cuid())

  storeId     String
  date        DateTime @db.Date

  orderCount  Int
  revenue     Decimal  @db.Decimal(12, 2)
  platformFee Decimal  @db.Decimal(12, 2)
  vendorPayout Decimal @db.Decimal(12, 2)

  createdAt   DateTime @default(now())

  @@unique([storeId, date])
  @@index([storeId])
  @@index([date])
  @@map("daily_sales")
}
