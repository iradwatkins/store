import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

/**
 * Add security headers to all responses
 * Note: Rate limiting is handled at API route level (not in middleware)
 * because Edge Runtime doesn't support ioredis
 */
function addSecurityHeaders(response: NextResponse): NextResponse {
  // HSTS: Force HTTPS for 1 year
  response.headers.set('Strict-Transport-Security', 'max-age=31536000; includeSubDomains')

  // Prevent clickjacking
  response.headers.set('X-Frame-Options', 'DENY')

  // Prevent MIME sniffing
  response.headers.set('X-Content-Type-Options', 'nosniff')

  // XSS Protection (legacy browsers)
  response.headers.set('X-XSS-Protection', '1; mode=block')

  // Referrer Policy
  response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin')

  // Content Security Policy (restrictive but allows necessary resources)
  const csp = [
    "default-src 'self'",
    "script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.stripe.com", // Stripe requires unsafe-inline/eval
    "style-src 'self' 'unsafe-inline'", // Tailwind requires unsafe-inline
    "img-src 'self' data: https: http:", // Allow external images from MinIO and CDNs
    "font-src 'self' data:",
    "connect-src 'self' https://api.stripe.com",
    "frame-src https://js.stripe.com",
    "object-src 'none'",
    "base-uri 'self'",
    "form-action 'self'",
  ].join('; ')
  response.headers.set('Content-Security-Policy', csp)

  // Permissions Policy (restrict browser features)
  response.headers.set('Permissions-Policy', 'geolocation=(), microphone=(), camera=()')

  return response
}

export async function middleware(request: NextRequest) {
  const hostname = request.headers.get('host') || ''
  const url = request.nextUrl.clone()

  // Extract subdomain
  // Examples:
  // - nike.stepperslife.com → subdomain = "nike"
  // - stores.stepperslife.com → subdomain = "stores" (main domain)
  // - localhost:3008 → subdomain = "localhost"
  const parts = hostname.split('.')
  const subdomain = parts[0]

  // Skip tenant detection for main domain and localhost
  const isMainDomain = subdomain === 'stores' || subdomain === 'www' || hostname.includes('localhost')

  // If subdomain detected and not main domain, check if tenant exists
  if (!isMainDomain && subdomain) {
    // For now, we'll just inject the subdomain as a header
    // In a future update, we can query the database here
    // Note: Edge runtime doesn't support Prisma, so we'd need to use fetch to an API

    const response = NextResponse.next()

    // Inject subdomain into request headers for use in API routes/pages
    response.headers.set('x-tenant-slug', subdomain)

    // Add security headers
    return addSecurityHeaders(response)
  }

  // Continue with request for main domain
  const response = NextResponse.next()

  // Add security headers
  return addSecurityHeaders(response)
}

export const config = {
  matcher: ['/((?!_next|[^?]*\\.(?:html?|css|js(?!on)|jpe?g|webp|png|gif|svg|ttf|woff2?|ico|csv|docx?|xlsx?|zip|webmanifest)).*)','/(api|trpc)(.*)'],
}
