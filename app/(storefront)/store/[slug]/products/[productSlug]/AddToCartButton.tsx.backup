"use client"

import { useState } from "react"

type Variant = {
  id: string
  type: string
  name: string
  price: number | null
  inventoryQuantity: number | null
}

type Product = {
  id: string
  name: string
  basePrice: number
  slug: string
  image?: string
  trackInventory: boolean
  inventoryQuantity: number | null
}

export default function AddToCartButton({
  product,
  variants,
  storeSlug,
}: {
  product: Product
  variants: Variant[]
  storeSlug: string
}) {
  const [selectedVariant, setSelectedVariant] = useState<string | null>(
    variants.length > 0 ? variants[0].id : null
  )
  const [quantity, setQuantity] = useState(1)
  const [isAdding, setIsAdding] = useState(false)
  const [message, setMessage] = useState<{ type: "success" | "error"; text: string } | null>(
    null
  )

  const hasVariants = variants.length > 0
  const selectedVariantData = hasVariants
    ? variants.find((v) => v.id === selectedVariant)
    : null

  const currentPrice = selectedVariantData?.price || product.basePrice
  const currentInventory = hasVariants
    ? selectedVariantData?.inventoryQuantity
    : product.inventoryQuantity

  const maxQuantity = product.trackInventory && currentInventory !== null
    ? Math.min(currentInventory, 10)
    : 10

  const isOutOfStock =
    product.trackInventory && currentInventory !== null && currentInventory <= 0

  const handleAddToCart = async () => {
    setIsAdding(true)
    setMessage(null)

    try {
      const response = await fetch("/api/cart/add", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          productId: product.id,
          variantId: selectedVariant,
          quantity,
          storeSlug,
        }),
      })

      const result = await response.json()

      if (!response.ok) {
        throw new Error(result.error || "Failed to add to cart")
      }

      setMessage({ type: "success", text: "Added to cart!" })

      // Refresh cart count if you have a cart component
      window.dispatchEvent(new Event("cartUpdated"))

      // Reset message after 3 seconds
      setTimeout(() => setMessage(null), 3000)
    } catch (err) {
      setMessage({
        type: "error",
        text: err instanceof Error ? err.message : "Something went wrong",
      })
    } finally {
      setIsAdding(false)
    }
  }

  return (
    <div className="space-y-6">
      {/* Variant Selection */}
      {hasVariants && (
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            Select {variants[0].type === "SIZE" ? "Size" : "Color"}
          </label>
          <div className="grid grid-cols-4 gap-2">
            {variants.map((variant) => {
              const variantOutOfStock =
                product.trackInventory &&
                variant.inventoryQuantity !== null &&
                variant.inventoryQuantity <= 0

              return (
                <button
                  key={variant.id}
                  onClick={() => setSelectedVariant(variant.id)}
                  disabled={variantOutOfStock}
                  className={`px-4 py-2 text-sm font-medium rounded-md border ${
                    selectedVariant === variant.id
                      ? "border-indigo-600 bg-indigo-50 text-indigo-600"
                      : variantOutOfStock
                      ? "border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed"
                      : "border-gray-300 bg-white text-gray-700 hover:bg-gray-50"
                  }`}
                >
                  {variant.name}
                  {variant.price && (
                    <span className="block text-xs mt-1">
                      ${variant.price.toFixed(2)}
                    </span>
                  )}
                </button>
              )
            })}
          </div>
        </div>
      )}

      {/* Quantity Selector */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">
          Quantity
        </label>
        <div className="flex items-center space-x-3">
          <button
            onClick={() => setQuantity(Math.max(1, quantity - 1))}
            className="px-3 py-2 border border-gray-300 rounded-md hover:bg-gray-50"
          >
            <svg className="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 12H4" />
            </svg>
          </button>
          <input
            type="number"
            min="1"
            max={maxQuantity}
            value={quantity}
            onChange={(e) =>
              setQuantity(Math.min(maxQuantity, Math.max(1, parseInt(e.target.value) || 1)))
            }
            className="w-20 text-center border-gray-300 rounded-md"
          />
          <button
            onClick={() => setQuantity(Math.min(maxQuantity, quantity + 1))}
            disabled={quantity >= maxQuantity}
            className="px-3 py-2 border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <svg className="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
            </svg>
          </button>
        </div>
        {product.trackInventory && currentInventory !== null && (
          <p className="mt-2 text-sm text-gray-500">
            {currentInventory > 0
              ? `${currentInventory} available`
              : "Out of stock"}
          </p>
        )}
      </div>

      {/* Price Summary */}
      <div className="border-t border-gray-200 pt-6">
        <div className="flex items-center justify-between text-lg">
          <span className="font-medium text-gray-900">Total:</span>
          <span className="font-semibold text-gray-900">
            ${(currentPrice * quantity).toFixed(2)}
          </span>
        </div>
      </div>

      {/* Add to Cart Button */}
      <button
        onClick={handleAddToCart}
        disabled={isAdding || isOutOfStock}
        className="w-full py-3 px-6 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed"
      >
        {isAdding
          ? "Adding to Cart..."
          : isOutOfStock
          ? "Out of Stock"
          : "Add to Cart"}
      </button>

      {/* Message */}
      {message && (
        <div
          className={`rounded-md p-4 ${
            message.type === "success"
              ? "bg-green-50 text-green-800"
              : "bg-red-50 text-red-800"
          }`}
        >
          <p className="text-sm font-medium">{message.text}</p>
        </div>
      )}
    </div>
  )
}
